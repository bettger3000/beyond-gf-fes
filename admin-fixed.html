<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>店舗管理システム【完全修正版】- ビヨンドグルテンフリー祭り 2025</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Hiragino Sans', 'Yu Gothic', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
.container { max-width: 1600px; margin: 0 auto; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
.header { background: linear-gradient(135deg, #2c5f2d 0%, #4a7c59 100%); color: white; padding: 30px; text-align: center; }
.header h1 { font-size: 32px; margin-bottom: 10px; }
.nav { padding: 20px; border-bottom: 2px solid #eee; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
.btn { background: #2c5f2d; color: white; border: none; padding: 12px 24px; border-radius: 25px; font-size: 16px; cursor: pointer; font-weight: bold; transition: all 0.3s; }
.btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
.btn-primary { background: #2c5f2d; }
.btn-add { background: #4a90e2; }
.btn-export { background: #e74c3c; }
.btn-import { background: #9b59b6; }
.btn-images { background: #ff9800; }
.btn-gray { background: #6c757d; }
.section { padding: 30px; }
.status { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #d2691e; padding: 20px; border-radius: 15px; font-size: 18px; font-weight: bold; margin-bottom: 30px; text-align: center; }
.shops-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px; margin-top: 20px; }
.shop-card { background: white; border: 2px solid #2c5f2d; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(44,95,45,0.15); position: relative; }
.shop-card h3 { color: #2c5f2d; margin-bottom: 15px; font-size: 20px; }
.shop-info { margin: 10px 0; color: #555; font-size: 14px; line-height: 1.6; }
.shop-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; position: absolute; top: 20px; right: 20px; border: 2px solid #ddd; }
.shop-actions { margin-top: 15px; display: flex; gap: 10px; }
.btn-edit { background: #4a90e2; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; }
.btn-delete { background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; }
.form-group { margin-bottom: 20px; }
.form-group label { display: block; font-weight: bold; margin-bottom: 8px; color: #333; font-size: 14px; }
.form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
.form-group textarea { resize: vertical; min-height: 100px; }
.checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; }
.checkbox-group label { display: flex; align-items: center; font-weight: normal; font-size: 14px; }
.checkbox-group input { width: auto; margin-right: 5px; }
.form-actions { text-align: center; margin-top: 30px; }
.modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
.modal-content { background: white; width: 95%; max-width: 900px; margin: 30px auto; border-radius: 20px; padding: 30px; max-height: 90vh; overflow-y: auto; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
.modal-close { background: none; border: none; font-size: 30px; cursor: pointer; color: #999; }
.success { color: #2c5f2d; }
.error { color: #e74c3c; }
.loading { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #2c5f2d; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.form-section { border-top: 2px solid #eee; margin-top: 30px; padding-top: 20px; }
.form-section-title { font-size: 18px; color: #2c5f2d; margin-bottom: 15px; font-weight: bold; }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>🍞 店舗管理システム【完全修正版】</h1>
    <p>ビヨンドグルテンフリー祭り 2025 - 修正完了！</p>
  </div>
  
  <div class="nav">
    <button class="btn btn-primary" onclick="showSection('list')">📋 店舗一覧</button>
    <button class="btn btn-add" onclick="showSection('add')">➕ 新規登録</button>
    <button class="btn btn-export" onclick="exportData()">💾 データエクスポート</button>
  </div>
  
  <!-- 店舗一覧セクション -->
  <div id="section-list" class="section">
    <div id="status" class="status">
      <span class="loading"></span>
      データを読み込んでいます...
    </div>
    <div id="shops-grid" class="shops-grid"></div>
  </div>

  <!-- 新規登録セクション -->
  <div id="section-add" class="section" style="display:none;">
    <h2>新規店舗登録</h2>
    <div class="form-group">
      <label for="add-name">店舗名 *</label>
      <input type="text" id="add-name" required>
    </div>
    <div class="form-group">
      <label for="add-short">短い説明</label>
      <input type="text" id="add-short">
    </div>
    <div class="form-group">
      <label for="add-address">住所</label>
      <input type="text" id="add-address">
    </div>
    <div class="form-group">
      <label for="add-thumb">サムネイル画像URL</label>
      <input type="url" id="add-thumb">
      <img id="thumb-preview" style="display:none; width: 100px; height: 100px; object-fit: cover; margin-top: 10px; border-radius: 8px;">
    </div>
    <div class="form-actions">
      <button class="btn btn-add" onclick="addShop()">📝 登録する</button>
      <button class="btn btn-gray" onclick="showSection('list')">キャンセル</button>
    </div>
  </div>
</div>

<!-- 編集モーダル -->
<div id="edit-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>店舗編集</h2>
      <button class="modal-close" onclick="closeEditModal()">&times;</button>
    </div>
    <input type="hidden" id="edit-id">
    <div class="form-group">
      <label for="edit-name">店舗名 *</label>
      <input type="text" id="edit-name" required>
    </div>
    <div class="form-group">
      <label for="edit-short">短い説明</label>
      <input type="text" id="edit-short">
    </div>
    <div class="form-group">
      <label for="edit-address">住所</label>
      <input type="text" id="edit-address">
    </div>
    <div class="form-group">
      <label for="edit-thumb">サムネイル画像URL</label>
      <input type="url" id="edit-thumb">
      <img id="edit-thumb-preview" style="display:none; width: 100px; height: 100px; object-fit: cover; margin-top: 10px; border-radius: 8px;">
    </div>
    <div class="form-actions">
      <button class="btn btn-primary" onclick="updateShop()">📝 更新する</button>
      <button class="btn btn-gray" onclick="closeEditModal()">キャンセル</button>
    </div>
  </div>
</div>

<script>
const API_BASE = 'https://gf-fes-api.bettger1000.workers.dev/api';
let shops = [];

// 初期化
document.addEventListener('DOMContentLoaded', function() {
  loadShops();
  
  // プレビュー機能
  document.getElementById('add-thumb').addEventListener('input', function() {
    const preview = document.getElementById('thumb-preview');
    if (this.value && !this.value.endsWith('.svg')) {
      preview.src = this.value;
      preview.style.display = 'block';
      preview.onerror = function() { this.style.display = 'none'; };
    } else {
      preview.style.display = 'none';
    }
  });
  
  document.getElementById('edit-thumb').addEventListener('input', function() {
    const preview = document.getElementById('edit-thumb-preview');
    if (this.value && !this.value.endsWith('.svg')) {
      preview.src = this.value;
      preview.style.display = 'block';
      preview.onerror = function() { this.style.display = 'none'; };
    } else {
      preview.style.display = 'none';
    }
  });
});

// セクション表示切替
function showSection(sectionName) {
  document.querySelectorAll('.section').forEach(section => {
    section.style.display = 'none';
  });
  document.getElementById('section-' + sectionName).style.display = 'block';
}

// 店舗データ読み込み
function loadShops() {
  fetch(API_BASE + '/shops')
    .then(response => response.json())
    .then(data => {
      shops = data;
      displayShops();
    })
    .catch(error => {
      console.error('Error:', error);
      document.getElementById('status').innerHTML = '<span class="error">❌ データの読み込みに失敗しました</span>';
    });
}

// 店舗一覧表示
function displayShops() {
  const statusDiv = document.getElementById('status');
  const gridDiv = document.getElementById('shops-grid');
  
  if (!shops || shops.length === 0) {
    statusDiv.innerHTML = '<span class="error">登録済み店舗がありません</span>';
    gridDiv.innerHTML = '';
    return;
  }
  
  statusDiv.innerHTML = `<span class="success">✅ ${shops.length}件の店舗を管理中</span>`;
  
  let html = '';
  shops.forEach(shop => {
    html += `
      <div class="shop-card">
        ${shop.thumb && !shop.thumb.endsWith('.svg') ? `<img src="${shop.thumb}" alt="${shop.name}" class="shop-thumb" onerror="this.style.display='none'">` : ''}
        <h3>${shop.name || '名前未設定'}</h3>
        ${shop.short ? `<div class="shop-info">📝 ${shop.short}</div>` : ''}
        ${shop.address ? `<div class="shop-info">📍 ${shop.address}</div>` : ''}
        <div class="shop-actions">
          <button class="btn-edit" onclick="editShop('${shop.id}')">✏️ 編集</button>
          <button class="btn-delete" onclick="deleteShop('${shop.id}')">🗑️ 削除</button>
        </div>
      </div>
    `;
  });
  
  gridDiv.innerHTML = html;
}

// 新規店舗追加
function addShop() {
  const name = document.getElementById('add-name').value.trim();
  if (!name) {
    alert('店舗名を入力してください');
    return;
  }
  
  const shopData = {
    name: name,
    short: document.getElementById('add-short').value.trim(),
    address: document.getElementById('add-address').value.trim(),
    thumb: document.getElementById('add-thumb').value.trim()
  };
  
  fetch(API_BASE + '/shops', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(shopData)
  })
  .then(response => {
    if (response.ok) {
      alert('✅ 店舗を登録しました！');
      document.getElementById('add-name').value = '';
      document.getElementById('add-short').value = '';
      document.getElementById('add-address').value = '';
      document.getElementById('add-thumb').value = '';
      document.getElementById('thumb-preview').style.display = 'none';
      loadShops();
      showSection('list');
    } else {
      alert('❌ 登録に失敗しました');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('❌ 通信エラーが発生しました');
  });
}

// 編集モーダル表示
function editShop(id) {
  const shop = shops.find(s => s.id === id);
  if (!shop) return;
  
  document.getElementById('edit-id').value = shop.id.toString();
  document.getElementById('edit-name').value = shop.name || '';
  document.getElementById('edit-short').value = shop.short || '';
  document.getElementById('edit-address').value = shop.address || '';
  document.getElementById('edit-thumb').value = shop.thumb || '';
  
  // プレビュー設定
  const preview = document.getElementById('edit-thumb-preview');
  if (shop.thumb && !shop.thumb.endsWith('.svg')) {
    preview.src = shop.thumb;
    preview.style.display = 'block';
  } else {
    preview.style.display = 'none';
  }
  
  document.getElementById('edit-modal').style.display = 'block';
}

// 店舗更新
function updateShop() {
  const id = document.getElementById('edit-id').value.split(':')[0]; // ID修正
  const name = document.getElementById('edit-name').value.trim();
  
  if (!name) {
    alert('店舗名を入力してください');
    return;
  }
  
  const shopData = {
    name: name,
    short: document.getElementById('edit-short').value.trim(),
    address: document.getElementById('edit-address').value.trim(),
    thumb: document.getElementById('edit-thumb').value.trim()
  };
  
  fetch(API_BASE + '/shops/' + id, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(shopData)
  })
  .then(response => {
    if (response.ok) {
      alert('✅ 店舗情報を更新しました！');
      closeEditModal();
      loadShops();
    } else {
      alert('❌ 更新に失敗しました');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('❌ 通信エラーが発生しました');
  });
}

// 店舗削除
function deleteShop(id) {
  const shop = shops.find(s => s.id === id);
  if (!shop) return;
  
  if (!confirm(`「${shop.name}」を削除しますか？\nこの操作は取り消せません。`)) {
    return;
  }
  
  fetch(API_BASE + '/shops/' + id.split(':')[0], { // ID修正
    method: 'DELETE'
  })
  .then(response => {
    if (response.ok) {
      alert('✅ 店舗を削除しました');
      loadShops();
    } else {
      alert('❌ 削除に失敗しました');
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('❌ 通信エラーが発生しました');
  });
}

// モーダル閉じる
function closeEditModal() {
  document.getElementById('edit-modal').style.display = 'none';
}

// データエクスポート
function exportData() {
  const dataStr = JSON.stringify(shops, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'shops_data.json';
  link.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>