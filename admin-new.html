<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>店舗管理画面 - ビヨンドグルテンフリー祭り</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Serif+JP:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-base: #F5F3F0;
      --color-white: #FFFFFF;
      --color-text: #2C2C2C;
      --color-text-light: #6B6B6B;
      --color-green: #4A5D4F;
      --color-gold: #B8985A;
      --color-accent: #D4634A;
      --color-line: #E8E0D6;
      --color-success: #22c55e;
      --color-danger: #ef4444;
      --font-serif: 'Noto Serif JP', serif;
      --font-sans: 'Noto Sans JP', sans-serif;
      --spacing-sm: 16px;
      --spacing-md: 24px;
      --spacing-lg: 32px;
      --radius: 8px;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-sans);
      background: var(--color-base);
      color: var(--color-text);
      line-height: 1.6;
    }

    .header {
      background: var(--color-white);
      padding: var(--spacing-md);
      box-shadow: var(--shadow);
      margin-bottom: var(--spacing-lg);
    }

    .header h1 {
      font-family: var(--font-serif);
      color: var(--color-green);
      text-align: center;
      font-size: 2rem;
      margin-bottom: var(--spacing-sm);
    }

    .nav {
      display: flex;
      gap: var(--spacing-sm);
      justify-content: center;
      flex-wrap: wrap;
    }

    .nav-btn {
      background: var(--color-green);
      color: var(--color-white);
      border: none;
      padding: 12px 24px;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .nav-btn:hover {
      background: var(--color-gold);
      transform: translateY(-2px);
    }

    .nav-btn.active {
      background: var(--color-accent);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 var(--spacing-md);
    }

    .section {
      background: var(--color-white);
      border-radius: var(--radius);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow);
      display: none;
    }

    .section.active {
      display: block;
    }

    .section h2 {
      font-family: var(--font-serif);
      color: var(--color-green);
      margin-bottom: var(--spacing-md);
      font-size: 1.5rem;
    }

    .shop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: var(--spacing-md);
    }

    .shop-card {
      border: 2px solid var(--color-line);
      border-radius: var(--radius);
      padding: var(--spacing-md);
      transition: all 0.3s ease;
    }

    .shop-card:hover {
      border-color: var(--color-gold);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .shop-name {
      font-family: var(--font-serif);
      font-size: 1.2rem;
      color: var(--color-green);
      margin-bottom: var(--spacing-sm);
    }

    .shop-info {
      color: var(--color-text-light);
      font-size: 0.9rem;
      margin-bottom: var(--spacing-sm);
    }

    .upload-section {
      border: 2px dashed var(--color-line);
      border-radius: var(--radius);
      padding: var(--spacing-md);
      text-align: center;
      margin: var(--spacing-md) 0;
      transition: all 0.3s ease;
    }

    .upload-section:hover {
      border-color: var(--color-gold);
      background: rgba(184, 152, 90, 0.05);
    }

    .file-input {
      display: none;
    }

    .file-label {
      display: inline-block;
      background: var(--color-green);
      color: var(--color-white);
      padding: 10px 20px;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .file-label:hover {
      background: var(--color-gold);
    }

    .success-msg {
      background: var(--color-success);
      color: white;
      padding: 10px;
      border-radius: var(--radius);
      margin-top: 10px;
      display: none;
    }

    .btn {
      background: var(--color-green);
      color: var(--color-white);
      border: none;
      padding: 10px 20px;
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 5px;
    }

    .btn:hover {
      background: var(--color-gold);
    }

    .btn-danger {
      background: var(--color-danger);
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    input, textarea, select {
      width: 100%;
      padding: 10px;
      border: 2px solid var(--color-line);
      border-radius: var(--radius);
      font-size: 1rem;
      margin-bottom: 10px;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--color-gold);
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-group {
      margin-bottom: var(--spacing-md);
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: var(--color-green);
    }

    .image-preview {
      max-width: 100px;
      max-height: 100px;
      border-radius: var(--radius);
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>店舗管理画面</h1>
    <nav class="nav">
      <button class="nav-btn active" data-section="list">店舗一覧</button>
      <button class="nav-btn" data-section="add">新規追加</button>
      <button class="nav-btn" data-section="export">データ出力</button>
    </nav>
  </div>

  <div class="container">
    <section id="list" class="section active">
      <h2>登録済み店舗一覧</h2>
      <div id="shopsList" class="shop-grid">
        <!-- ショップリストがここに表示されます -->
      </div>
    </section>

    <section id="add" class="section">
      <h2>新規店舗追加</h2>
      <form id="addShopForm">
        <div class="form-group">
          <label for="shopName">店舗名</label>
          <input type="text" id="shopName" name="name" required>
        </div>
        
        <div class="form-group">
          <label for="shopCategory">カテゴリ</label>
          <select id="shopCategory" name="category" multiple>
            <option value="ベーカリー">ベーカリー</option>
            <option value="レストラン">レストラン</option>
            <option value="カフェ">カフェ</option>
            <option value="スイーツ">スイーツ</option>
          </select>
        </div>

        <div class="form-group">
          <label>サムネイル画像</label>
          <div class="upload-section">
            <input type="file" id="thumbInput" class="file-input" accept="image/*">
            <label for="thumbInput" class="file-label">画像を選択</label>
            <div id="thumbSuccess" class="success-msg">✅ 画像のアップロードが完了しました！</div>
          </div>
        </div>

        <div class="form-group">
          <button type="button" class="btn" onclick="testUpload()">テスト送信</button>
        </div>
      </form>
    </section>

    <section id="export" class="section">
      <h2>データ出力</h2>
      <p>店舗データをJSON形式で出力します。</p>
      <button class="btn" onclick="exportData()">データを出力</button>
    </section>
  </div>

  <script>
    console.log('管理画面スクリプト開始');
    
    const API_BASE = 'https://gf-fes-api.bettger1000.workers.dev';
    
    // ナビゲーション制御
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM読み込み完了');
      
      // ナビゲーションボタンのイベント
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const targetSection = this.dataset.section;
          
          // アクティブ状態を更新
          document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // セクション表示を更新
          document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
          document.getElementById(targetSection).classList.add('active');
        });
      });
      
      // 画像アップロードのイベント
      document.getElementById('thumbInput').addEventListener('change', function() {
        handleImageUpload(this, 'thumb');
      });
      
      // 店舗データを読み込み
      loadShops();
    });

    // 店舗データを読み込む
    async function loadShops() {
      try {
        console.log('店舗データ読み込み開始');
        const response = await fetch(`${API_BASE}/api/shops`);
        const shops = await response.json();
        console.log('取得した店舗数:', shops.length);
        displayShops(shops);
      } catch (error) {
        console.error('店舗データ読み込みエラー:', error);
      }
    }

    // 店舗一覧を表示
    function displayShops(shops) {
      const container = document.getElementById('shopsList');
      container.innerHTML = shops.map(shop => `
        <div class="shop-card">
          <div class="shop-name">${shop.name}</div>
          <div class="shop-info">
            カテゴリ: ${Array.isArray(shop.category) ? shop.category.join(', ') : '未設定'}
          </div>
          <div class="shop-info">
            住所: ${shop.address || '未設定'}
          </div>
          ${shop.thumb ? `<img src="${convertImagePath(shop.thumb)}" class="image-preview" alt="サムネイル">` : ''}
        </div>
      `).join('');
    }

    // 画像パス変換
    function convertImagePath(imagePath) {
      if (!imagePath) return '';
      if (imagePath.startsWith('http')) return imagePath;
      if (imagePath.includes('.svg') || imagePath.includes('.png') || 
          imagePath.includes('.jpg') || imagePath.includes('.jpeg') || 
          imagePath.includes('.webp')) {
        return `${API_BASE}/api/image/${imagePath}`;
      }
      return imagePath;
    }

    // 画像アップロード処理
    async function handleImageUpload(input, type) {
      const file = input.files[0];
      if (!file) return;

      console.log('画像アップロード開始:', file.name);

      try {
        // プログレス表示
        const progressDiv = document.createElement('div');
        progressDiv.style.color = '#007bff';
        progressDiv.style.marginTop = '10px';
        progressDiv.textContent = '⏳ アップロード中...';
        input.parentElement.appendChild(progressDiv);

        const formData = new FormData();
        formData.append('image', file);
        
        const response = await fetch(`${API_BASE}/api/upload-image`, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error(`アップロード失敗: ${response.status}`);
        }

        const result = await response.json();
        console.log('アップロード成功:', result);

        // プログレス削除
        progressDiv.remove();

        // 成功メッセージ表示
        const successDiv = input.parentElement.querySelector('.success-msg');
        if (successDiv) {
          successDiv.style.display = 'block';
          setTimeout(() => {
            successDiv.style.display = 'none';
          }, 3000);
        }

      } catch (error) {
        console.error('画像アップロードエラー:', error);
        alert('画像のアップロードに失敗しました: ' + error.message);
        input.value = '';
        
        // プログレス削除
        const progressDiv = input.parentElement.querySelector('div[style*="color: #007bff"]');
        if (progressDiv) progressDiv.remove();
      }
    }

    // テストアップロード
    function testUpload() {
      console.log('テストアップロード実行');
      const input = document.getElementById('thumbInput');
      if (input.files.length > 0) {
        handleImageUpload(input, 'thumb');
      } else {
        alert('まず画像ファイルを選択してください');
      }
    }

    // データ出力
    async function exportData() {
      try {
        const response = await fetch(`${API_BASE}/api/shops`);
        const shops = await response.json();
        
        const dataStr = JSON.stringify(shops, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'shops-data.json';
        link.click();
        
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error('データ出力エラー:', error);
        alert('データ出力に失敗しました');
      }
    }

    console.log('管理画面スクリプト準備完了');
  </script>
</body>
</html>